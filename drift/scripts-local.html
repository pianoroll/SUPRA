
<script>
// vim: ts=3


//////////////////////////////
//
// displayDruid --
//

function displayDruid(druid) {
	console.log("DRUID = ", druid);
	if (!druid) {
		return;
	}

	var info = DRUIDINFO[druid].info;
	if (!info) {
		return;
	}

	var letter = druid.charAt(0);
	// var prefix = "https://supra.stanford.edu/drift/";
	var prefix = "";
	var file = prefix + "data/" + letter + "/" + druid + "_drift.json";

	var firsthole = info.FIRST_HOLE;
	if (firsthole) {
		firsthole = parseInt(firsthole);
		var calc = "(datum.r - " + firsthole  + ")/12.0/300.25";
		PLOT.transform[0].calculate = calc;
	}

	PLOT.data.url = file;

	var PLOT_SLOPE = JSON.parse(JSON.stringify(PLOT));
	PLOT_SLOPE.encoding.y.field = "s";
	PLOT_SLOPE.encoding.y.title = "smoothed slope [px]";
	PLOT_SLOPE.encoding.color = {"value": "#ff0000"};
	delete PLOT_SLOPE.encoding.y.scale;

	var PLOT_ACCEL = JSON.parse(JSON.stringify(PLOT));
	PLOT_ACCEL.encoding.y.field = "a";
	PLOT_ACCEL.encoding.y.title = "smoothed acceleration [px]";
	PLOT_ACCEL.encoding.color = {"value": "#00ff00"};
	delete PLOT_ACCEL.encoding.y.scale;

	vegaEmbed("#plot", PLOT);
	vegaEmbed("#plot-slope", PLOT_SLOPE);
	vegaEmbed("#plot-accel", PLOT_ACCEL);
	var element = document.querySelector("#info");
	if (!element) {
		return;
	}
	displayInfo(element, info);
}



//////////////////////////////
//
// displayInfo --
//

function displayInfo(element, info) {
	if (!element) {
		return;
	}
	if (!info) {
		return;
	}

	var available = 1;
	if (!info.DRIFT_RANGE) {
		available = 0;
	}

	var feet;
	var meter;

	var output = "";
	output += "<table class='info'>";

	output += "<tr>";
	output += "<td>";
	output += "DRUID:";
	output += "<td>";
	output += "<td>";
	output += "<a href='/?q=druid%3A" + info.DRUID + "'>";
	output += info.DRUID;
	output += "</a>";
	if (available) {
		output += "&nbsp;";
		output += "&nbsp;";
		output += "&nbsp;";
		output += "<a title='Scan of roll and audio' target='purl' href='/uv/?id=" + info.DRUID + "'><i style='color:#999;' class='fa fa-image'></i></a>";
		}
	output += "<td>";
	output += "</tr>";

	if (available) {
		output += "<tr>";
		output += "<td>";
		output += "Drift range:";
		output += "<td>";
		output += "<td>";
		output += info.DRIFT_RANGE;
		var mm = parseFloat(info.DRIFT_RANGE) / 300.25 * 25.54;
		mm = parseInt(mm * 10.0 + 0.5)/10.0;
		output += " / " + mm + " mm ";
		output += " (";
		output += info.DRIFT_MAX;
		output += " to ";
		output += info.DRIFT_MIN;
		output += ")";
		output += "<td>";
		output += "</tr>";
	}

	if (available) {
		output += "<tr>";
		output += "<td>";
		output += "Prefix length:";
		output += "<td>";
		output += "<td>";
		feet = parseFloat(info.FIRST_HOLE) / 300.25 / 12.0;
		meter = feet * 12.0 * 25.4 / 1000.0;
		feet = parseInt(feet * 100.0 + 0.5)/100.0;
		meter = parseInt(meter * 1000.0 + 0.5)/1000.0;
		output += feet + " ft / " + meter + " m ";
		output += " (distance from start of scan to leading edge of first hole)";
		output += "<td>";
		output += "</tr>";
	}

	if (available) {
		output += "<tr>";
		output += "<td>";
		output += "Music length:";
		output += "<td>";
		output += "<td>";
		var feet = parseFloat(info.MUSICAL_LENGTH) / 300.25 / 12.0;
		var meter = feet * 12.0 * 25.4 / 1000.0;
		meter = parseInt(meter * 1000.0 + 0.5)/1000.0;
		feet = parseInt(feet * 100.0 + 0.5)/100.0;
		output += feet + " ft / " + meter + " m ";
		output += " (distance from first hole to last hole)";
		output += "<td>";
		output += "</tr>";
	}

	if (available) {
		output += "<tr>";
		output += "<td>";
		output += "Scan length:";
		output += "<td>";
		output += "<td>";
		var feet = parseFloat(info.IMAGE_LENGTH) / 300.25 / 12.0;
		var meter = feet * 12.0 * 25.4 / 1000.0;
		meter = parseInt(meter * 1000.0 + 0.5)/1000.0;
		feet = parseInt(feet * 100.0 + 0.5)/100.0;
		output += feet + " ft / " + meter + " m ";
		output += "<td>";
		output += "</tr>";
	}

	output += "<tr>";
	output += "<td>";
	output += "Label:";
	output += "<td>";
	output += "<td>";
	output += info.LABEL;
	output += "<td>";
	output += "</tr>";

	output += "<tr>";
	output += "<td>";
	output += "Title:";
	output += "<td>";
	output += "<td>";
	output += info.TITLE;
	output += "<td>";
	output += "</tr>";

	output += "<tr>";
	output += "<td>";
	output += "Composer:";
	output += "<td>";
	output += "<td>";
	output += info.COMPOSER;
	output += "<td>";
	output += "</tr>";

	output += "<tr>";
	output += "<td>";
	output += "Performer:";
	output += "<td>";
	output += "<td>";
	output += info.PERFORMER;
	output += "<td>";
	output += "</tr>";

	output += "</table>";
	element.innerHTML = output;
}



//////////////////////////////
//
// displayPrevDruid --
//

function displayPrevDruid() {
	var entry = DRUIDINFO[DRUID];
	if (!entry) {
		return;
	}
	DRUID = entry.prev;
	displayDruid(DRUID);
}



//////////////////////////////
//
// displayNextDruid --
//

function displayNextDruid() {
	var entry = DRUIDINFO[DRUID];
	if (!entry) {
		return;
	}
	DRUID = entry.next;
	displayDruid(DRUID);
}



//////////////////////////////
//
// buildDruidIndex --
//

function buildDruidIndex(rollinfo) {
	DRUIDINFO = {};
	var druid;
	var druidnext;
	var druidprev;
	var obj;
	for (var i=1; i<rollinfo.length - 1; i++) {
		druid = rollinfo[i].DRUID;
		druidnext = rollinfo[i+1].DRUID;
		druidprev = rollinfo[i-1].DRUID;
		DRUIDINFO[druid] = {
			info: rollinfo[i],
			curr: druid,
			next: druidnext,
			prev: druidprev
		};
	}

	// and endpoints

	DRUIDINFO[rollinfo[0].DRUID] = {
		info: rollinfo[0],
		curr: rollinfo[0].DRUID,
		next: rollinfo[1].DRUID,
		prev: rollinfo[rollinfo.length-1].DRUID
	};

	DRUIDINFO[rollinfo[rollinfo.length-1].DRUID] = {
		info: rollinfo[rollinfo.length-1],
		curr: rollinfo[rollinfo.length-1].DRUID,
		next: rollinfo[0].DRUID,
		prev: rollinfo[rollinfo.length-2].DRUID
	};
}



</script>
